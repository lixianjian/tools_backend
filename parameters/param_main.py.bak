#!/usr/bin/python2.7
#coding=utf-8
'''
Created on 2013-8-9

@author: lixianjian
'''

from django.template import RequestContext
from django.http import HttpResponse,HttpResponseForbidden,HttpResponseServerError
#from django.http import HttpResponseNotFound
from django.http import HttpResponseRedirect
from django.shortcuts import render_to_response
from django.core.context_processors import csrf
from django.views.decorators.csrf import csrf_exempt
#from django.contrib.auth.models import User
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.forms.models import model_to_dict
from south.db import db
from django.db import connection

import urllib
import os
import sys
import json
from datetime import timedelta
#import re
import traceback as tb
#import uuid
import subprocess
import shlex
import psutil
import time
import csv
import copy

#from settings import MEDIA_ROOT
from libs import public
from libs.config import glocale,DEBUG,PER_PAGE,ASSETS_URL,PARAM_DEBUG_PATH,AUTO_ADD_FIELD
from libs.register import login,alter,logout
from models import *

reload(sys)
sys.setdefaultencoding('utf-8')

#静态数据
const_data  = {'glocale': glocale,
               'assets_url': ASSETS_URL,
               }

#主模板目录
INDEX_PAGE  = 'main.html'
#登陆页面路径
LOGIN_PAGE  = 'login/login_page.html'
#参数表模板
PARAM_HTML_PATH = 'parameters'
#数字正则式
NUMBER_STR  ='\d{1,9}'
#时间正则表达式，如：2012-07-26 17:22:22
TIME_RE_STR ='\d{4}-\d{2}-\d{2}\s{1}\d{2}:\d{2}:\d{2}'
#日期正则表达式，如：2012-07-26
DATE_RE_STR ='\d{4}-\d{2}-\d{2}'
#浮点正则表达式
FLOAT_STR   = '(\d+)(\.\d+)'

def create_db_table(record,model_class,suffix=''):
    """ Takes a Django model class and create a database table, if necessary.
    """
    # XXX Create related tables for ManyToMany etc
    db.start_transaction()
    table_name = model_class._meta.db_table
    if suffix:
        table_name  += suffix
    # Introspect the database to see if it doesn't already exist
    if (connection.introspection.table_name_converter(table_name) not in connection.introspection.table_names()):
        fields  = [(f.name, f.get_django_field()) for f in record.fields.all()]
        if DEBUG:
            print fields
        db.create_table(table_name, fields)
        # Some fields are added differently, after table creation
        # eg GeoDjango fields
        db.execute_deferred_sql()
        print "Created table '%s'" % table_name
    db.commit_transaction()

def delete_db_table(model_class):
    table_name = model_class._meta.db_table
    db.start_transaction()
    db.delete_table(table_name)
    print "Deleted table '%s'" % table_name
    db.commit_transaction()

def add_db_table_column(model_class, field_name, field):
    table_name = model_class._meta.db_table
    db.start_transaction()
    #db.delete_table(table_name)
    db.add_column(table_name, field_name, field)
    print "table '%s' add colum %s" %(table_name, field_name)
    db.commit_transaction()

def alter_db_table_column(model_class, field_name, field):
    print 'in alter_db_table_column'
    table_name = model_class._meta.db_table
    db.start_transaction()
    db.alter_column(table_name, field_name, field)
    print "table '%s' alter colum %s" %(table_name, field_name)
    db.commit_transaction()

def delete_db_table_column(model_class, field_name, field_type):
    table_name = model_class._meta.db_table
    db.start_transaction()
    if field_type == 'ForeignKey':
        db.delete_foreign_key(table_name, field_name)
    elif field_type == 'AutoField':
        db.delete_primary_key(table_name)
    else:
        db.delete_column(table_name, field_name)
    print "table '%s' delete colum %s" %(table_name, field_name)
    db.commit_transaction()

def rename_db_table_column(model_class, field_name, new_name, field_type=''):
    table_name = model_class._meta.db_table
    db.start_transaction()
    db.rename_column(table_name, field_name, new_name)
    if field_type == 'ForeignKey':
        #db.rename_column(table_name, field_name+'_id', new_name+'_id')
        db.add_column(table_name, new_name+'_id', models.IntegerField(verbose_name=new_name+'_id',blank=True,null=True))
    db.commit_transaction()
    print "table '%s' rename colum %s to %s" %(table_name, field_name, new_name)

def get_contact(obj,**kwargs):
    """ 获取obj的记录 """
    try:
        contact = obj.objects.get(**kwargs)
    except obj.DoesNotExist:
        contact = {}
    return contact

def get_sheets():
    """ 获取参数表 """
    sheets  = {}
    for sheet in Sheet.objects.all():
        sys_markid  = sheet.sys_model.markid
        sys_markid2 = sheet.sys_model2.markid
        if sheets.has_key(sys_markid):
            if sheets[sys_markid]['sub_sheets'].has_key(sys_markid2):
                sheets[sys_markid]['sub_sheets'][sys_markid2]['sub_sheets2'].append(sheet)
            else:
                sheets[sys_markid]['sub_sheets'][sys_markid2]   = {'sys_model2': sheet.sys_model2, 'sub_sheets2': [sheet]}
        else:
            sheets[sys_markid]  = {'sys_model': sheet.sys_model, 'sub_sheets':{sys_markid2:{'sys_model2': sheet.sys_model2, 'sub_sheets2': [sheet]}}}
    #print sheets
    return sheets.values()

def some_view(data, output_name='excel_data'):
    """"""
    response = HttpResponse(mimetype='text/csv')
    response.write('\xEF\xBB\xBF')
    response['Content-Disposition'] = 'attachment; filename=%s.csv'%output_name
    writer = csv.writer(response)
    print 'make csv'
    for row in data:
        out_row = []
        for value in row:
            if not isinstance(value, basestring):
                value   = unicode(value)
            if value is None:
                value   = ''
            out_row.append(value.replace('"', '""'))
        writer.writerow(out_row)
    return response

def entrance(request):
    """ 入口 """
    if DEBUG:
        print 'HTTP_HOST:',request.META['HTTP_HOST']
        public.print_str('entrance')
        public.print_str('------- request.user: %s'%request.user)
        public.print_str('------- request.user.username: %s'%request.user.username)
    if request.user.is_authenticated():
        return choose_param(request)
    if request.method == 'GET':
        pre_path= request.get_full_path()
        content = {'form_action':'/login/','glocale': glocale,'pre_path': pre_path}
        content.update(csrf(request))
        return render_to_response(LOGIN_PAGE,content)
    elif request.method == 'POST':
        pre_path= request.POST.get('pre_path')
        msg = login(request)
        if msg.get('status',1) == 0:
            if not request.user.has_perm('auth.view_web'):
                logout(request)
                return HttpResponseForbidden()
            if pre_path is not None:
                return HttpResponseRedirect(pre_path)
            return choose_param(request)
        else:
            content = {'tips': msg.get('tips',glocale.LN_UID_NAME_ERROR),'form_action':'/login/',
                       'glocale': glocale,'pre_path': pre_path}
            page_path   = LOGIN_PAGE
            content.update(csrf(request))
            return render_to_response(page_path,content,context_instance=RequestContext(request))
    else:
        return HttpResponseServerError()
        
def quity(request):
    """ 出口 """
    logout(request)
    return entrance(request)

def alter_password(request):
    """ 修改密码 """
    #req_msg = get_request_data(request)
    content = {'data_title': glocale.LN_ALTER_PASSWORD,
               'form_action':'/alter_password/',}
    if request.method == 'GET':
        content.update({'html_path':'login/alter.html'})
        #return render_to_response(INDEX_PAGE,content,context_instance=RequestContext(request))
    elif request.method == 'POST':
        msg = alter(request)
        if msg.get('status',1) == 0:
            content.update({'tips': msg.get('tips',glocale.LN_CHOOSE_FUNC_IN_LEFT_FRAME),'html_path':'login/alter.html'})
        else:
            content.update({'tips': msg.get('tips',glocale.LN_FAIL),'html_path':'login/alter.html'})
    else:
        return HttpResponseServerError()
    content.update(const_data)
    content.update(csrf(request))
    return render_to_response(INDEX_PAGE,content,context_instance=RequestContext(request))

def choose_param(request,tips=''):
    """ 选择游戏项目 """
    if request.method == 'POST':
        req_msg = request.POST
    else:
        req_msg = request.GET
    pid  = req_msg.get('programid')
    localeid= req_msg.get('localeid')
    if public.objIsFull(pid) and public.objIsFull(localeid):
        try:
            program = Program.objects.get(markid=pid)
        except Program.DoesNotExist:
            program = None
        try:
            locale  = Locale.objects.get(markid=localeid)
        except Locale.DoesNotExist:
            locale  = None
        try:
            prog_loc_user   = ProgramLocaleUser.objects.get(program=program.id,locale=locale.id,user=request.user.id)
        except ProgramLocaleUser.DoesNotExist:
            prog_loc_user   = None
        content = {'program': program, 'locale': locale,'sheets': get_sheets(), 'prog_loc_user': prog_loc_user}
        content.update(csrf(request))
        return render_to_response(INDEX_PAGE, content,context_instance=RequestContext(request))
    else:
        objs= ProgramLocaleUser.objects.filter(user=request.user.id)
        if public.objIsEmpty(objs):
            content = {'tips':tips+u'抱歉，目前没有项目，请先添加','form_action':'choose_param'}
        else:
            content = {'programs': objs,'form_action':'choose_param'}
        content.update(csrf(request))
        return render_to_response('parameters/choose_program.html',content,context_instance=RequestContext(request))

@csrf_exempt
def param_main_response(request,pid=None,localeid=None,sheetid=None):
    """ 响应入口 """
    print 'HTTP_HOST:',request.META['HTTP_HOST']
    program = get_contact(Program,markid=pid)
    locale  = get_contact(Locale,markid=localeid)
    if sheetid == 'model':
        sheet   = {'name':'model','intro': '参数表'}
    else:
        sheet   = get_contact(Sheet,name=sheetid)
    prog_loc_user   = get_contact(ProgramLocaleUser,program=program.id,locale=locale.id,user=request.user.id)
    info= {'program': program, 'locale': locale,'sheets': get_sheets(),'sheet': sheet, 'prog_loc_user': prog_loc_user}
    reqmode = request.GET.get('reqmode')
    view_all= request.GET.get('view_all','0') == '1'
    #调用相关功能模块进行处理
    obj = ParamMain(request,program,locale,sheetid,reqmode,view_all)
    if bool(sheetid) and (bool(sheet) or hasattr(obj,sheetid)):
        if reqmode not in ['js']:
            obj.content.update(info)
        if hasattr(obj,sheetid):
            getattr(obj, sheetid)()
        else:
            obj.do_sheet()
            if obj.export_csv:
                #return ExcelResponse(obj.csv_datas,obj.csv_name)
                return some_view(obj.csv_datas,obj.csv_name)
        content = obj.content
        #载入页面
        if sheetid in ['model','protobufdata','restart']:
            content['html_path']= PARAM_HTML_PATH+'/'+sheetid+'.html'
        else:
            content['html_path']= PARAM_HTML_PATH+'/parameters.html'
        if DEBUG:
            public.print_str('html_path: %s'%content['html_path'])
        #content['sheets']   = Sheets.objects.all()
    else:
        content = {'html_path': PARAM_HTML_PATH+'/right_default.html',
                   'data_title': glocale.LN_CHOOSE_FUNC_IN_LEFT_FRAME,
                   }
        content.update(info)
    if reqmode == 'js':
        if DEBUG:
            #print '--------- content: ',content
            pass
        for k in ['paginator','camps','entrys','elem_sizes','topo_rule_types','qualitys','wuxings','cardfirstlevels','cardsecondlevels','combos','upper_keys']:
            if content.has_key(k):
                content.pop(k)        
        if content.has_key('datas'):
            if content.get('do_what') == 'get':
                content['datas']= json.dumps(content['datas'])
            else:
                del content['datas']
        return HttpResponse(json.dumps(content))
    else:
        content.update(const_data)
        content.update(csrf(request))
        return render_to_response(INDEX_PAGE,content,context_instance=RequestContext(request))

class ParamMain():
    
    def __init__(self,request,program,locale,sheetid,reqmode,view_all):
        self.request= request
        self.req_method = 'GET'
        #self.pid    = pid
        self.program= program
        self.pname  = program.name
        #self.localeid   = localeid
        self.locale = locale
        self.localename = locale.name
        self.sheetid= sheetid
        self.sheetname  = sheetid
        self.reqmode= reqmode
        #显示所有记录
        self.view_all   = view_all
        #参数表字段
        self.pkeys  = []
        #参数表字段名
        self.pvalues= []
        self.content= {}
        self.yesterday  = (datetime.datetime.now() - timedelta(days = 1)).strftime('%Y-%m-%d')
        self.today  = datetime.datetime.today().strftime('%Y-%m-%d')
        #当前操作的数据表对象
        self.sheet_obj  = None
        #数据表参数
        self.achieves= {}
        #数据表传入参数中控参数
        self.empties= []
        #是否显示全屏flash
        self.full_screen_swf= False
        self.full_screen_swf_name   = ''
        #卡片类型
        self.card_type  = 0
        #页面错误提示
        self.tips   = ''
        #查询条件
        self.filter_kwargs  = {}
        #记录ID
        self.recordid   = 0
        #文字类型
        self.text_type  = 0
        #导出EXCEL
        self.export_csv = False
        #EXCEL文件名
        self.csv_name   = 'anonymous'
        #EXCEL数据
        self.csv_datas  = []
        #表包含的字段数据
        self.fields = []
        #字段参数
        self.fields_settings= []
        #动态表在参数表中的实例
        self.dyn_model  = None
        #模板内容
        self.temp_html  = ''
        #操作类型
        self.do_what    = 'get'
        #外键字典
        self.foreign_keys   = {}
#        #多对多字典
#        self.manytomanys= {}
        #排序字段
        self.order  = ''
        
    def alter_password(self):
        """ 修改密码 """
        self.sheetname  = glocale.LN_ALTER_PASSWORD
        if self.request.method == 'GET':
            pass
        elif self.request.method == 'POST':
            msg = alter(self.request)
            if msg.get('status',1) == 0:
                self.content.update({'tips': msg.get('tips',glocale.LN_CHOOSE_FUNC_IN_LEFT_FRAME)})
            else:
                self.content.update({'tips': msg.get('tips',glocale.LN_FAIL)})
        else:
            return HttpResponseServerError()
    
    def do_data(self):
        """ 处理数据库表 """
        datas   = {}
        for sheet in Sheet.objects.filter(program=self.program.id, is_proto=True, deleted=False):
#            if sheet.name != 'bigtpye2smalltype':
#                continue
            print 'sheet.name: ',sheet.name
            datas[sheet.name]   = []
            dyn_obj = sheet.get_django_model()
            #多对多中对象
            to_objs = {}
            fields  = Field2.objects.filter(model=sheet.id)
            for f in fields:
#                if f.name == 'small_type':
#                    print f.name
                if f.type.name == 'ManyToManyField':
                    try:
                        to_sheet= Sheet.objects.get(program=self.program.id, name=f.to, deleted=False)
                    except Sheet.DoesNotExist:
                        public.print_str('ManyToManyField sheet [%s] does not exist'%f.to)
                    else:
                        to_objs[f.name] = {'display': to_sheet.display, 'to_obj': to_sheet.get_django_model()}
                        for f2 in to_sheet.fields.all():
                            if f2.to == sheet.name:
                                to_objs[f.name]['key']  = f2.name
            for record in dyn_obj.objects.filter(deleted=False):
                v1  = {}
                for f in fields:
                    t1  = f.type.name
                    name= f.name
                    if name in AUTO_ADD_FIELD:
                        continue
                    v2  = getattr(record,name)
                    if v2 is None:
                        if t1 in ['IntegerField', 'BigIntegerField']:
                            v2  = 0
                        elif t1 == 'FloatField':
                            v2  = 0.0
                        elif t1 == 'BooleanField':
                            v2  = False
                        elif t1 in ['CharField','ImageField','TextField']:
                            v2  = ''
                    if t1 == 'ForeignKey':
                        if v2 is None:
                            v1[name]= 0
                        else:
                            if f.to_field:
                                v1[name]= getattr(v2,f.to_field)
                            else:
                                v1[name]= getattr(v2,'sn')
                            #v1[name]= model_to_dict(v2,exclude=AUTO_ADD_FIELD)
                    elif t1 == 'ManyToManyField':
                        if v2 is None:
                            v1[name]= 0
                        else:
                            #多对多中间表对象
                            if to_objs.has_key(name):
                                v1[name]= [getattr(v3,to_objs[name]['display']).sn for v3 in to_objs[name]['to_obj'].objects.filter(**{to_objs[name]['key']: record.id,'deleted': False})]
                            else:
                                v1[name]= []
                    elif t1 == 'JSONChar':
                        #JSON格式
                        if v2:
                            try:
                                v1[name]= json.loads(v2)
                            except:
                                print sheet.name, record.id, name, v2
                                v1[name]= []
                        else:
                            v1[name]= []
                    else:
                        v1[name]= v2
                datas[sheet.name].append(v1)
            #本文件所在上层目录
            pfd = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            path= os.path.join(pfd,self.program.markid+'/db.txt')
            print 'path: ',path
            public.write_json_file(path, datas)
            #return datas
#                print 'type(record):',type(record)
#                print "type(record._meta.fields): ",type(record._meta.fields)
#                for f in record._meta.fields:
#                    print "%s=%s"%(f.name, getattr(record,f.name))
#                    print 'type(f): ',type(f)
#                    print 'help(f): ',help(f)
#                for k,v in record.iterator():
#                    print k,v
    
    def protobufdata(self):
        """ 生成服务器、客户端数据，protobuf上下行文件 """
        self.sheetname  = u'生成服务器、客户端数据，protobuf上下行文件'
        if self.request.method == 'POST':
            req_msg = self.request.POST
        else:
            req_msg = self.request.GET
        recreate= (req_msg.get('recreate') == '1')
        msg = None
        ret = 0
        procid  = self.request.GET.get('procid','0')
        if recreate == True:
            try:
                if public.objIsEmpty(procid):
                    procid  = 0
                else:
                    procid  = int(float(procid))
                #没有执行程序
                if procid < 1:
                    #修改执行目录权限
                    self.do_data()
                    shl = 'ssh root@localhost chown -R nobody.nobody /opt/darkhutgame/cgame/cgame_shared/protobuf/'
                    subprocess.call(shlex.split(shl))
                    cmd = '/opt/darkhutgame/cgame/cgame_shared/protobuf/run_protobuf_test.sh'
                    public.print_str('--------- command: %s'%cmd)
                    #用Popen启动子进程，子进程无法正常退出，使用call替代
#                    popen   = subprocess.Popen(shlex.split(cmd), shell=False, stdout=None, stderr=None)
##                    if psutil.pid_exists(procid):
##                        print '----------- procid1 is exist: ', procid
##                        #time.sleep(5)
#                    public.print_str('popen stdout: %s'%popen.stdout)
#                    public.print_str('popen stderr: %s'%popen.stderr)
#                    procid  = popen.pid
                    subprocess.call(shlex.split(cmd))
                    procid  = 65536
                #ret: 返回值，0:已完成，1:正在执行，2:报错
                if psutil.pid_exists(procid):
                    print '----------- procid is exist: ', procid
                    ret = 1
                    msg = u'正在执行'
                else:
                    ret = 0
                    procid  = 0
                    msg = u'已完成'
            except:
                procid  = 0
                ret = 2
                msg = '%r'%tb.format_exc()
                public.print_str(msg)
        self.content.update({'ret': ret, 'msg': msg, 'procid': procid, 
                             'sheet': {'markid': 'protobufdata','name':u'生成数据库&data.swf&上下行','addness': True}})
    
    def restart(self):
        """ 重启进程 """
        self.sheetname  = u'重启进程'
        force   = self.request.GET.get('force','0')=='1'
        if force:
#            shl1 = 'ssh root@localhost python2.7 /opt/darkhutgame/support/tools_backend/cgame/tools_backend/project_ctl.py stop'
#            subprocess.call(shlex.split(shl1))
#            print shl1
#            time.sleep(2)
#            shl2 = 'ssh root@localhost python2.7 /opt/darkhutgame/support/tools_backend/cgame/tools_backend/project_ctl.py start'
#            print shl2
#            subprocess.call(shlex.split(shl2))
            shl = 'ssh root@localhost /opt/darkhutgame/support/tools_backend/cgame/tools_backend/run_protobuf_test.sh'
            print shl
            subprocess.call(shlex.split(shl))
            
        time.sleep(2)
        
    def modifylog(self):
        """ 参数表修改记录 """
        self.sheetname  = u'参数表修改记录'
        if self.request.method == 'POST':
            req_msg = self.request.POST
        else:
            req_msg = self.request.GET
        today   = datetime.today().strftime('%Y-%m-%d')
        start_day   = req_msg.get('start_day',today)
        end_day = req_msg.get('end_day',today)
        
        cmd = 'sh /opt/darkhutgame/kashen_shared/protobuf/run_protobuf_test.sh'
        public.print_str('--------- command: %s'%cmd)
        try:
            if public.objIsEmpty():
                procid  = 0
            else:
                procid  = int(float(procid))
            #没有执行程序
            if procid < 1:
                popen   = subprocess.Popen(shlex.split(cmd), shell=True, stdout=None, stderr=None)
                if psutil.pid_exists(procid):
                    print '----------- procid1 is exist: ', procid
                    #time.sleep(5)
                #public.print_str('%s'%popen.stdout)
                procid  = popen.pid
            #ret: 返回值，0:已完成，1:正在执行，2:报错
            if psutil.pid_exists(procid):
                print '----------- procid is exist: ', procid
                ret = 1
                msg = u'正在执行'
            else:
                ret = 0
                procid  = 0
                msg = u'已完成'
        except:
            procid  = 0
            ret = 2
            msg = '%r'%tb.format_exc()
            public.print_str(msg)
        self.content.update({'ret': ret, 'msg': msg, 'procid': procid, 
                             'sheet': {'sheetid': 'protobufdata','name':u'生成数据库&data.swf&上下行','addness': True}})
        
    def paging(self,obj,per_page,page,**kwargs):
        """ 分页 """
        #print 'obj:',obj
        if public.objIsFull(kwargs):
            objects = obj.objects.filter(**kwargs)
        else:
            objects = obj.objects.all()
        if self.order:
            objects = objects.order_by(self.order)
        #每页两条数据的一个分页器
        paginator   = Paginator(objects, per_page)
        try:
            contacts = paginator.page(int(page))
        except PageNotAnInteger:
            # If page is not an integer, deliver first page.
            contacts = paginator.page(1)
        except EmptyPage:
            # If page is out of range (e.g. 9999), deliver last page of results.
            contacts = paginator.page(paginator.num_pages)
        return paginator,contacts
    
    def list_upper(self, l1, s_char='_', index=0):
        """ 将字符串(两个单词之间用'_'分隔)中的第index个字母转成大写 """
        l2  = []
        for s1 in l1:
            tmp_str = ''
            if s_char in s1:
                s2  = s1.split(s_char)
                tmp_str = s2[0]
                for s3 in s2[1:]:
                    #tmp_str += str.replace(str[index], str[index].upper())
                    tmp_str += s3[0].upper()+s3[1:]
            else:
                tmp_str = s1
            l2.append(tmp_str)
        return l2
        
    def string2other(self,ps,mode,name):
        """ 将字符串ps转换成其他类型 mode"""
        modes   = {'int':u'整数','float':u'小数','json':u'列表或字典'}
        data= ps
        try:
            if mode == 'int':            
                data= int(ps)
            elif mode == 'float':
                data= float(ps)
            elif mode == 'json':
                data= json.loads(ps)
        except:
            self.tips   += u'[%s]不是[%s]字符串，'%(name,modes.get(mode,mode))
        return data
    
    def sheet_init(self):
        """ 数据表参数初始化 """
        try:
            if self.sheetid == 'model':
                self.sheet_obj  = Sheet
            else:
                self.dyn_model  = Sheet.objects.get(program=self.program.id,name=self.sheetid)
        except Sheet.DoesNotExist:
            self.sheet_obj  = None
            #return '表【%s】不存在'%self.sheetname
        else:
            if self.sheetid == 'model':
                self.content['field_types'] = FieldType2.objects.all()
                self.content['tables']  = Sheet.objects.filter(program=self.program.id)
                self.content['sys_models']  = SystemModels.objects.filter(program=self.program.id)
                self.content['sys_models2'] = SystemModels2.objects.filter(program=self.program.id)
                self.achieves['program']= self.program
                self.achieves['locale'] = self.locale
                self.pkeys  = ['sys_model','sys_model2','name','intro','num','is_proto','display','field']
                self.pvalues= [u'一级目录',u'二级目录',u'英文名',u'中文名',u'最后一个记录ID',u'是否上下行表',u'外键表显示字段(英文名)',u'字段',]
            else:
                self.sheet_obj  = self.dyn_model.get_django_model()
#                print '--------------- self.dyn_model.fields'
#                for field in self.sheet_obj._meta.fields:
#                    print field.name
#                print 'self.dyn_model.id:',self.dyn_model.id
#                print 'self.dyn_model.name:',self.dyn_model.name
                self.fields = Field2.objects.filter(model=self.dyn_model.id).exclude(name__in=AUTO_ADD_FIELD)
                for f in self.fields:
                    if f.type.name == 'ForeignKey':
                        self.foreign_keys[f.name] = Sheet.objects.get(program=self.program.id,name=f.to).display
                    elif f.type.name == 'ManyToManyField':
                        #self.foreign_keys[f.name] = Sheet.objects.get(program=self.program.id,name=f.to).intro
                        #于2014-05-09 16:33修改，不显示表名，显示对应的SN列表
                        to_obj  = Sheet.objects.get(program=self.program.id,name=f.to)
                        display = to_obj.display
                        primary_key = ''
                        for f2 in to_obj.fields.exclude(name__in=AUTO_ADD_FIELD):
                            if f2.name != display:
                                primary_key = f2.name
                                break
                        self.foreign_keys[f.name] = {'to_obj': to_obj.get_django_model(),'display': display, 'primary_key': primary_key}
#                for f in Field2.objects.exclude(model=self.dyn_model.id,name__in=['createtime','username']):
#                    self.pkeys.append(f.name)
#                    self.pvalues.append(f.intro)
    
    def sheet_do_add_req_data(self):
        """ 处理数据表增加、修改参数 """
        #修改人
        self.achieves['username']   = self.request.user.username
        self.achieves['createtime'] = datetime.datetime.now()
        if self.sheetid == 'model':
            #参数表,model
            for index in range(0,len(self.pkeys)):
                k   = self.pkeys[index]
                name= self.pvalues[index]
                if k in ['field']:
                    record_count= self.request.POST.get(k+'_index')
#                    v1  = []
                    if public.objIsFull(record_count):
                        for i in range(1,int(record_count)):
                            field_id= self.string2other(self.request.POST.get(k+'_id%s'%i,0), 'int', name+'记录ID')
                            status_id   = self.string2other(self.request.POST.get(k+'_status%s'%i,1), 'int', name+'记录状态')
#                            if field_id is None:
#                                continue
                            name1   = self.request.POST.get(k+'_name%s'%i)
                            intro   = self.request.POST.get(k+'_intro%s'%i)
                            type1   = self.request.POST.get(k+'_type%s'%i)
                            to  = self.request.POST.get(k+'_to%s'%i)
                            to_field= self.request.POST.get(k+'_to_field%s'%i)
                            max_length  = self.request.POST.get(k+'_max_length%s'%i)
                            help= self.request.POST.get(k+'_help%s'%i)
#                            default = self.request.POST.get(k+'_default%s'%i)
                            if public.objsIsEmpty([name1,intro,type1]):
                                self.tips   = name+'英文名、中文名、类型中有空参数'
                                public.print_str('name,intro,type1: %s, %s, %s'%(name1,intro,type1))
                                #break
                            else:
#                                sets= []
                                try:
                                    type_obj= FieldType2.objects.get(id=int(type1))
                                except FieldType2.DoesNotExist:
                                    type_obj= None
                                    self.tips   = '字段类型不存在ID【%s】'%type1
                                    print 'self.tips:',self.tips
#                                if type1 == 'ForeignKey':
#                                    if to == '0':
#                                        self.tips   = name+'外键参数为空'
#                                    else:
#                                        try:
#                                            to_obj  = Sheet.objects.get(id=int(to))
#                                        except Sheet.DoesNotExist:
#                                            self.tips   = name+'外键参数对应的表不存在'
#                                            #to  = self.string2other(to,'int',name+'外键参数对应的表')
#                                        else:
#                                            to  = to_obj#.__class__.__name__
#                                else:
#                                    to  = 
                                if type_obj is not None and type_obj.name in ['CharField','ImageField','JSONChar']:
                                    if public.objIsEmpty(max_length):
                                        max_length  = 255
                                    max_length  = self.string2other(max_length,'int',name+'最大长度')
                                else:
                                    max_length  = 0
                                self.fields.append({'id': field_id,
                                                    'status': status_id,
                                                    'name': name1,
                                                    'intro': intro,
                                                    'type': type_obj,
                                                    'to': to,
                                                    'to_field': to_field,
                                                    'max_length': max_length,
                                                    #'help': help,
#                                                    'settings': sets,
                                                    })
                else:
                    v1  = public.req_param_rstrip(self.request.POST.get(k))
                    if k in ['num','sys_model','sys_model2']:
                        v1  = self.string2other(v1,'int',name)
                        if k == 'sys_model':
                            try:
                                v1  = SystemModels.objects.get(id=v1)
                            except SystemModels.DoesNotExist:
                                self.tips   += name+'不存在ID【%s】'%v1
                            print 'self.tips: ',self.tips
                        if k == 'sys_model2':
                            try:
                                v1  = SystemModels2.objects.get(id=v1)
                            except SystemModels2.DoesNotExist:
                                self.tips   += name+'不存在ID【%s】'%v1
                            print 'self.tips: ',self.tips
                    elif k == 'is_proto':
                        v1  = bool(v1=='1')
                    self.achieves[k]  = v1
            if public.objIsEmpty(self.tips) and self.do_what == 'add':
                if Sheet.objects.filter(program=self.program.id,name=self.achieves.get('name')):
                    self.tips   = '表名【%s】已经存在'%v1
                else:
                    self.fields.extend([{'name': 'id', 'intro': 'ID', 'type': FieldType2.objects.get(name='AutoField'),'to': '', 'max_length': 0, 'id': 0,'status': 1},
                                        {'name': 'createtime', 'intro': '创建时间', 'type': FieldType2.objects.get(name='DateTimeField'),'to': '', 'max_length': 0, 'id': 0,'status': 1},
                                        {'name': 'username', 'intro': '操作用户', 'type': FieldType2.objects.get(name='CharField'),'to': '', 'max_length': 50, 'id': 0,'status': 1},
                                        {'name': 'deleted', 'intro': '删除', 'type': FieldType2.objects.get(name='BooleanField'),'to': '', 'max_length': 0, 'id': 0,'status': 1},
                                        ])
#                    print "sheet_do_add_req_data:", self.fields
        else:
            #动态表
            self.achieves['deleted']    = False
            for f in self.fields:
                type_name   = f.type.name
#                if f.type.name == 'ManyToManyField':
#                    v1  = []
#                    for v2 in self.request.REQUEST.getlist(f.name):
#                        v1.append(self.string2other(v2,'int',f.intro))
#                    try:
#                        to_obj  = Sheet.objects.get(program=self.program.id, name=f.to)
#                    except Sheet.DoesNotExist:
#                        self.tips   = f.intro+'外键参数对应的表[%s]不存在'%f.to
#                    else:
#                        try:
#                            v1  = to_obj.get_django_model().objects.filter(id__in=v1)
#                        except to_obj.DoesNotExist:
#                            self.tips   = f.intro+'，表[%s]中不存在记录[%s]'%v1
#                    #print 'v1: ',v1
#                    self.manytomanys[f.name]= v1
#                    continue
#                else:
                v1  = public.req_param_rstrip(self.request.POST.get(f.name))
                if type_name == 'IntegerField':
                    v1  = self.string2other(v1, 'int', f.intro)
                elif type_name == 'FloatField':
                    v1  = self.string2other(v1, 'float', f.intro)
                elif type_name == 'ForeignKey':
                    v1  = self.string2other(v1,'int',f.intro)
                    try:
                        to_obj  = Sheet.objects.get(program=self.program.id, name=f.to)
                    except Sheet.DoesNotExist:
                        self.tips   = f.intro+'外键参数对应的表[%s]不存在'%f.to
                    else:
                        try:
                            v1  = to_obj.get_django_model().objects.get(id=v1)
                        except to_obj.DoesNotExist:
                            self.tips   = f.intro+'，表[%s]中不存在记录[%s]'%v1
                elif type_name == 'BooleanField':
                    v1  = bool(v1=='1')
                self.achieves[f.name]   = v1
    
    def do_modify_post_exception(self):
        """ 处理修改提交异常 """
        if self.sheetid == 'model':
            i   = 0
            for f in self.fields:
                if f['name'] in AUTO_ADD_FIELD:
                    del f
                i   += 1
            self.achieves['field']  = self.fields#json.loads(self.achieves['field'])
            self.content['field_len']   = len(self.achieves['field'])+1
            for f in self.achieves['field']:
                if f['type'].name == 'ForeignKey':
                    print 'name: ',f['name']
                    f['fields'] = [f.name for f in Sheet.objects.get(name=f['name']).fields.all().exclude(name__in=AUTO_ADD_FIELD)]
        
    def do_modify_get_special_field(self,db_obj):
        """ 处理修改获取的特殊字段 """
        if self.sheetid == 'model':
            model_id= db_obj.id
            db_obj  = model_to_dict(db_obj, fields=self.pkeys,exclude=['field'])
            db_obj['field']= Field2.objects.filter(model=model_id).exclude(name__in=AUTO_ADD_FIELD)
            self.content['field_len']   = len(db_obj['field'])+1
            fields  = []
            for f in db_obj['field']:
                f   = model_to_dict(f)
                if f['type'] == 9:                    
                    print 'name: ',f['to']
                    f['fields'] = [f2.name for f2 in Sheet.objects.get(name=f['to']).fields.all().exclude(name__in=AUTO_ADD_FIELD)]
                fields.append(f)
            db_obj['field'] = fields
            print db_obj['field']
            
#        else:
#            model_id= db_obj.id
#            db_obj  = model_to_dict(db_obj, fields=self.pkeys,exclude=AUTO_ADD_FIELD)
#            fields  = []
#            for f in self.fields:
#                if db_obj.has_key(f.name):
#                    fields.append({'name': f.name, 'intro': f.intro, 'value': db_obj['name'], 'type': f.type.name})
#                    #db_obj[f.name]  = {'intro': f.intro, 'value': db_obj['name'], 'type': f.type.name}
#            db_obj  = fields
        return db_obj
    
    def do_modify_get_exception(self):
        """ 处理修改获取异常 """
        if self.sheetid == 'model':
            self.content['field_len']   = 1
            
    def do_add_special(self,db_obj):
        """ 处理增加记录的特殊操作 """
        if self.sheetid == 'model':
#            i   = 0
#            print "do_add_special:", self.fields
            for f in self.fields:
#                if f['name'] in AUTO_ADD_FIELD:
#                    self.fields.pop(i)
                #排除不需要的字段
                _id = f.pop('id')
                status  = f.pop('status')
                if _id != 0 or status != 1:
                    continue
#                print f
                f['model']  = db_obj
                #添加字段表记录
                f_obj   = Field2(**f)
                f_obj.save()
#                i   += 1
            create_db_table(db_obj,db_obj.get_django_model())
        else:
            if self.dyn_model.num > 0:
                db_obj.sn   = self.dyn_model.num + db_obj.id-1
#                db_obj.sn   = self.dyn_model.num
                db_obj.save()
#                self.dyn_model.num  += 1
#                self.dyn_model.save()
#            for k,v in self.manytomanys.items():
#                setattr(db_obj,k,v)
#            db_obj.save()
        self.content['sheets']  = get_sheets()
    
    def do_modify_special(self,db_obj):
        """ 处理修改记录的特殊操作 """
        if self.sheetid == 'model':
            django_model = db_obj.get_django_model()
            modified = False
            new_fields  = copy.copy(AUTO_ADD_FIELD)
            new_foreign_keys    = []
            old_fields  = copy.copy(AUTO_ADD_FIELD)
            for f1 in self.fields:
                f   = copy.copy(f1)
                if f['name'] in AUTO_ADD_FIELD:
                    continue
                field_id= f.pop('id')
                status  = f.pop('status')
                #新增字段
                if field_id == 0:
                    if status > 1:
                        continue
                    f['model']  = db_obj
                    f_obj   = Field2(**f)
                    f_obj.save()
                    add_db_table_column(django_model,f['name'],f_obj.get_django_field())
                else:
                    if status == 1:
                        continue
                    else:
                        modified = True
                        try:
                            f_objs  = Field2.objects.filter(id=field_id)
                        except:
                            public.print_str('wariming: field id [%s] is not exists'%field_id)
                        else:
                            if public.objIsEmpty(f_objs):
                                public.print_str(u'记录ID【%s】不存在，请检查数据的正确性'%self.recordid)
                            else:
                                if status == 2:
                                    #删除
#                                    #原字段名
#                                    field_name  = f_objs[0].name
#                                    field_type  = f_objs[0].type.name
#                                    f_objs[0].delete()
#                                    delete_db_table_column(django_model, field_name, field_type)
                                    pass
                                else:
                                    #修改
                                    #原字段名
                                    field_name  = f_objs[0].name
                                    field_type  = f_objs[0].type.name
#                                    if f['name'] != field_name:
#                                        rename_db_table_column(django_model, field_name, f1['name'], field_type=f_objs[0].type.name)
                                    #修改Field2表记录
                                    f_objs.update(**f)
#                                    print 'field_name:',field_name
#                                    #修改对应表的字段
#                                    alter_db_table_column(django_model,field_name,f_objs[0].get_django_field())
                                    if f['type'].name == 'ForeignKey': 
                                        if field_type == 'ForeignKey':
                                            new_fields.append(f['name']+'_id')
                                            old_fields.append(field_name+'_id')
                                            try:
                                                db.delete_index(django_model._meta.db_table, [field_name])
                                            except:
                                                pass
#                                        else:
#                                            new_foreign_keys.append(f['name']+'_id')
#                                        print 'new_fields: ', new_fields
#                                        print 'old_fields: ', old_fields
                                    else:
                                        new_fields.append(f['name'])
                                        old_fields.append(field_name)
            if modified:
                t1  = '%d'%time.time()
                create_db_table(db_obj,django_model,suffix='_'+t1)
                table_name = django_model._meta.db_table
                db.execute('INSERT INTO %s(%s) select %s from %s'%(table_name+'_'+t1,','.join(new_fields),','.join(old_fields), table_name))
#                for f2 in new_foreign_keys:
#                    print 'update %s set %s=0'%(table_name+'_'+t1,f2)
#                    db.execute('update %s set %s=0'%(table_name+'_'+t1,f2))
                db.execute('drop table %s'%table_name)
                db.execute('alter table %s rename to %s'%(table_name+'_'+t1,table_name))
#                #添加字段表记录
#                f_obj   = Field2(**f)
#                f_obj.save()
            #create_db_table(db_obj,db_obj.get_django_model())
#        else:
#            if self.dyn_model.num > 0:
#                db_obj.sn   = self.dyn_model.num
#                db_obj.save()
#                self.dyn_model.num  += 1
#                self.dyn_model.save()

    def do_achieve_recordid(self):
        """ 处理特殊记录ID """
        if self.do_what in ['modify','delete'] and self.sheetid in ['topo_graph'] and self.reqmode == 'js':
            if self.do_what == 'modify':
                #print 'self.request.raw_post_data: ',self.request.raw_post_data
                self.recordid   = json.loads(self.request.raw_post_data).get('id','0')
            else:
                self.recordid   = self.request.GET.get('recordid','0')
#            if self.sheetid == 'topo_graph2' and int(self.recordid) < 1000:
#                self.recordid   = int(self.recordid) + 1000
            try:
                db_obj  = self.sheet_obj.objects.get(id=self.recordid)
            except self.sheet_obj.DoesNotExist:
                self.recordid= 0
            else:
                self.recordid   = db_obj.id
#                if self.sheetid == 'topo_graph2':
#                    self.recordid   += 1000
        else:
            self.recordid   = self.request.GET.get('recordid','0')
#        if self.sheetid == 'topo_graph2' and int(self.recordid) < 1000:
#            self.recordid   = int(self.recordid) + 1000
    
    def do_achieve_records(self,page):
        """ 处理获取记录数据 """
        #if self.sheetid in ['topo_graph','topo_map']:
        if self.view_all:
            pre_pages   = 10000
        else:
            pre_pages   = PER_PAGE
        if self.reqmode == 'js':
            paginator,records   = self.paging(self.sheet_obj,10000,1,deleted=False)
            datas   = []
            for record in records:
                datas.append(model_to_dict(record, fields=self.pkeys))
        elif self.export_csv:
            #paginator,contacts  = self.paging(self.sheet_obj,10000000,1,**self.achieves)
            paginator   = None
            datas   = self.sheet_obj.objects.filter(deleted=False)
        else:
            paginator,datas = self.paging(self.sheet_obj,pre_pages,page,deleted=False)
#            print datas
#        if public.objIsFull(datas):
#            print help(datas[0])
#            print datas[0].name.verbose_name
#            print datas[0].name.__class__.__name__
#            for k in datas[0]:
#                help(k)
#                break
#                self.pkeys.append()
#                self.pvalues.append()
        if self.sheetid != 'model':
            self.view_template(datas,page)
        return paginator,datas
    
    def set_filter_kwargs(self):
        """ 初始化查询条件 """
        self.filter_kwargs  = {'id': int(self.recordid)}
    
    def do_spec_table(self):
        """ 处理特殊表 """
        if self.sheetid == 'trade_npc':
            paginator,records   = self.paging(self.sheet_obj,10000,1,deleted=False)
            datas   = []
            for record in records:
                datas.append(model_to_dict(record, fields=self.pkeys))
            public.write_json_file(PARAM_DEBUG_PATH, {'trad_npc': datas}, end='\n')
            
    def do_record_del(self,db_obj):
        """ 处理删除表记录 """
        if self.sheetid == 'model':
            delete_db_table(db_obj.get_django_model())
            db_obj.delete()            
        else:
            db_obj.deleted  = True
            db_obj.save()
    
    def view_template(self,datas,page):
        """ 查看记录模板 """
        self.pkeys  = []
        self.pvalues= []
        for f in self.fields:
            self.pkeys.append(f.name)
            if f.type.name == 'ForeignKey':
                view_all= 0
                if self.view_all:
                    view_all= 1
                self.pvalues.append('<a href="/parameters/%(pid)s/%(loc_id)s/%(sheet_name)s/?do_what=get&page=%(number)s&view_all=%(view_all)s&o=%(name)s__id" class="order">%(intro)s</a>'% \
                                  {'pid': self.program.markid, 'loc_id': self.locale.markid, 'sheet_name': self.sheetid, 'intro': f.intro, 'number': page, 'name': f.name,'view_all': view_all})
            else:
                self.pvalues.append(f.intro)
        if public.objIsFull(datas):
            number  = datas.number
            for d1 in datas:
                #print 'd1.id:',d1.id
                #print 'd1:',model_to_dict(d1)
                self.temp_html  += '<tr>'
                #self.temp_html  += '<!-- 编辑 -->'
                self.temp_html  += '<td style="width:40px;">'
                self.temp_html  += '<a href="/parameters/%(pid)s/%(loc_id)s/%(sheet_name)s/?do_what=modify&recordid=%(recordid)s&page=%(number)s">编辑</a>'% \
                {'pid': self.program.markid, 'loc_id': self.locale.markid, 'sheet_name': self.sheetid, 'recordid': d1.id, 'number': number}
                self.temp_html  += '</td>'
                for f in self.fields:
                    self.temp_html   += '<!-- %s -->'%f.intro
                    self.temp_html  += '<td>'
                    print f.name
                    v1  = getattr(d1,f.name)
                    if v1 is None:
                        self.temp_html  += ''
                    else:
                        if f.type.name == 'ImageField':
                            #self.temp_html  += '<td width="40px">'
                            self.temp_html  += '<p><EMBED src="%(assets_url)s/cgame/assets/%(field)s.swf" width="75" height="75" wmode="transparent" menu="false" quality="high" type="application/x-shockwave-flash"></EMBED></p>'% \
                            {'assets_url': ASSETS_URL, 'field': v1}
                            self.temp_html  += '<p><a href="%(assets_url)s/cgame/assets/%(field)s.swf" target="_blank">%(field)s</a></p>'% \
                            {'assets_url': ASSETS_URL, 'field': v1}
                            #self.temp_html  += '</td>'
                        elif f.type.name == 'TextField':
                            self.temp_html  += '<a href="#" title="%(value)s">%(value_short)s</a>'%{'value': v1, 'value_short': v1[:8]}
                        elif f.type.name == 'ForeignKey':
                            if v1:
                                self.temp_html   += '%s'%getattr(v1,self.foreign_keys[f.name])
                            else:
                                self.temp_html   += ''
                        elif f.type.name == 'ManyToManyField':
                            #self.temp_html   += '%s'%self.foreign_keys[f.name]
                            #于2014-05-09 16:33修改，不显示表名，显示对应的SN列表
                            v2  = []
                            to_obj  = self.foreign_keys[f.name]['to_obj']
                            display = self.foreign_keys[f.name]['display']
                            primary_key = self.foreign_keys[f.name]['primary_key']
                            for r1 in to_obj.objects.filter(**{primary_key:d1.id,'deleted':False}):
    #                            print d1.id, r1
                                v2.append(getattr(r1,display).sn)
                            #v2  = [getattr(r1,display).sn for r1 in to_obj.objects.filter(id=d1.id,deleted=False)]
                            self.temp_html   += '%s'%v2
                        else:
                            self.temp_html   += '%s'%v1
                    self.temp_html  += '</td>'
                #self.temp_html  += '<!-- 其他操作 -->'
                self.temp_html  += '<td style="width:40px;">'
                #self.temp_html  += '<a href="/parameters/{{ program.markid }}/{{ locale.markid }}/{{ sheet.name }}/?do_what=delete&recordid={{ data.id }}&page={{ datas.number }}">删除</a>'
                self.temp_html  += '<a href="/parameters/%(pid)s/%(loc_id)s/%(sheet_name)s/?do_what=delete&recordid=%(recordid)s&page=%(number)s">删除</a>'% \
                {'pid': self.program.markid, 'loc_id': self.locale.markid, 'sheet_name': self.sheetid, 'recordid': d1.id, 'number': number}
                self.temp_html  += '</td>'
                self.temp_html  += '</tr>'
    
    def edit_template(self,db_obj):
        """ 编辑记录模板 """
        for f in self.fields:
            if f.name == 'sn':
                self.temp_html  += '<tr style="display:none;">'
            else:
                self.temp_html  += '<tr>'
            self.temp_html  += '<td class="right_td">%s：</td>'%f.intro
            self.temp_html  += '<td class="left_td"><p>'
            v1  = ''
            if public.objIsFull(db_obj):
                v1  = getattr(db_obj,f.name)
            if not v1:
                if f.type.name == 'IntegerField':
                    v1  = '0'
                elif f.type.name == 'FloatField':
                    v1  = '0.0'
                elif f.type.name == 'JSONChar':
                    v1  = '[]'
                elif f.type.name == 'TextField':
                    v1  = ''
            if f.type.name == 'BooleanField':
                self.temp_html  += '<label style="width:150px;float:left;background-color:#CCC;margin-right:2px;margin-bottom:2px;padding-left:5px;">'
                if v1:
                    self.temp_html  += '<input id="id_%(field)s" name="%(field)s" value="1" type="checkbox" checked="checked" />'%{'field': f.type.name}
                else:
                    self.temp_html  += '<input id="id_%(field)s" name="%(field)s" value="1" type="checkbox" />'%{'field': f.name}
                self.temp_html  += '<span style="color:#000;">%s</span>'%f.intro
                self.temp_html  += '</label>'
            elif f.type.name in ['ForeignKey','ManyToManyField']:
                try:
                    to_obj  = Sheet.objects.get(program=self.program.id,name=f.to)
                except Sheet.DoesNotExist:
                    self.tips   = '外键参数对应的表[%s]不存在'%f.to
                    public.print_str(self.tips)
                else:
                    if f.type.name == 'ForeignKey':
                        model_obj   = to_obj.get_django_model()
                        self.temp_html  += '<select id="id_%(name)s" name="%(name)s" style="width:150px;height:20px;">'%{'name': f.name}
                        self.temp_html  += '<option value="0">请选择一个%s</option>'%to_obj.intro
                        for record in model_obj.objects.filter(deleted=False):
                            param1  = {'id': record.id, 'intro': getattr(record,to_obj.display)}
                            if v1 and record.id == getattr(v1,'id'):
                                self.temp_html  += '<option value="%(id)s" selected="selected">%(intro)s</option>'%param1
                            else:
                                self.temp_html  += '<option value="%(id)s">%(intro)s</option>'%param1
                        self.temp_html  += '</select>'
                    else:
                        self.temp_html  += '%(sheetname)s<input id="id_%(field)s" name="%(field)s" style="width:150px;" value="%(value)s" type="hidden" />'% \
                        {'field': f.name, 'value': f.to, 'sheetname': to_obj.intro}
            elif f.type.name == 'ImageField':
                self.temp_html  += '<input id="id_%(field)s" name="%(field)s" style="width:150px;" value="%(value)s" type="text" />'%{'field': f.name, 'value': v1}
                self.temp_html  += '<a href="http://220.dhh.darkhutgame.net:8080/view_res/?gameid=%s&localeid=all" target="_blank">选择图片</a>'%self.program.markid
            elif f.type.name == 'TextField':
                self.temp_html  += '<textarea id="id_%(field)s" name="%(field)s" style="width:350px;height:120px;">%(value)s</textarea>'%{'field': f.name, 'value': v1}
            elif f.type.name == 'JSONChar':
#                print f.name, v1
                self.temp_html  += '<input id="id_%(field)s" name="%(field)s" style="width:350px;" value=\'%(value)s\' type="text" />'%{'field': f.name, 'value': v1}
                self.temp_html  += '&nbsp;&nbsp;<a href="javascript:void();" onclick="javascript:check_json(\'id_%(field)s\',\'%(intro)s\');">检查JSON格式</a>'%{'field': f.name, 'intro': f.intro}
                self.content['js_str']  = "javascript:return check_json(\'id_%(field)s\',\'%(intro)s\',\', 确认提交\');"%{'field': f.name, 'intro': f.intro}
            else:
                self.temp_html  += '<input id="id_%(field)s" name="%(field)s" style="width:150px;" value="%(value)s" type="text" />'%{'field': f.name, 'value': v1}
#            if f.help:
#                self.temp_html  += '</p><p>&nbsp;&nbsp;%s'%f.help
            self.temp_html  += '</p></td>'
            self.temp_html  += '</tr>'
    
    def do_sheet(self):
        """ 处理表 """
        self.sheet_init()
        self.req_method = self.request.method
        self.do_what= urllib.unquote(self.request.GET.get('do_what', 'get'))
        page    = self.request.GET.get('page', '1')
        #recordid= self.request.GET.get('recordid','0')
        self.export_csv = (self.request.GET.get('export_csv') == '1')
        self.order  = self.request.GET.get('o','')
        self.do_achieve_recordid()
        paginator   = None
        datas   = None
        if self.sheet_obj is None:
            self.tips   = '表【%s】不存在'%self.sheetname
        #查看玩家反馈信息
        elif self.do_what == 'get':
            #paginator,datas = self.paging(self.sheet_obj,PER_PAGE,page,deleted=False)
            paginator,datas = self.do_achieve_records(page)
            if self.export_csv:
                public.print_str('make csv data start')
                self.csv_name= self.sheetname
                if os.path.exists('/root'):
                    self.csv_name   = public._2utf8(self.csv_name)
                else:
                    self.csv_name   = str(self.csv_name)
                self.csv_datas.append(self.pvalues)
                self.csv_datas.append(self.pkeys)
                for record in datas:
                    l1  = []
                    for key in self.pkeys:
                        try:
                            v1  = getattr(record, key)
                        except AttributeError:
                            public.print_str('key [%s] is not exist'%key)
                        else:
                            l1.append(v1)
                    self.csv_datas.append(l1)
                public.print_str('make csv data end')
        elif self.do_what in ['add','modify']:
            if self.req_method == 'POST':
                #self.achieves = {'createtime': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),'uuid':'%s'%uuid.uuid4(),
                #                'deleted':False}
                self.sheet_do_add_req_data()
                #有空数据
                if public.objIsFull(self.empties):
                    self.tips= u'【%s】为空'%(u'，'.join(self.empties))
                    self.do_modify_post_exception()
                    datas   = self.achieves
                elif public.objIsFull(self.tips):
                    self.do_modify_post_exception()
                    datas   = self.achieves
                else:
                    #添加记录
                    if self.do_what == 'add':
                        #print self.achieves
                        db_obj  = self.sheet_obj(**self.achieves)
                        db_obj.save()
                        self.do_add_special(db_obj)
                        #最后一页查看刚刚添加的数据记录
                        page= 9999
                    #修改记录
                    else:
                        if public.objIsEmpty(self.recordid):
                            self.tips= u'记录ID为空，请检查数据的正确性'
                        else:
                            try:
                                self.set_filter_kwargs()
                                db_objs = self.sheet_obj.objects.filter(**self.filter_kwargs)
                            #except self.sheet_obj.DoesNotExist:
                            except:
                                self.tips= u'记录ID【%s】不存在，请检查数据的正确性'%self.recordid
                                self.do_modify_post_exception()
                                datas   = self.achieves
                            else:
                                if public.objIsEmpty(db_objs):
                                    public.print_str(u'记录ID【%s】不存在，请检查数据的正确性'%self.recordid)
                                    self.do_modify_post_exception()
                                    datas   = self.achieves
                                else:
                                    #public.print_str(u'记录ID【%s】更新， %s'%(self.recordid,self.achieves))
                                    db_objs.update(**self.achieves)
                                    self.do_modify_special(db_objs[0])
                    if public.objIsEmpty(self.tips):
                        #获取最后一页的数据
                        #paginator,datas = self.paging(self.sheet_obj,PER_PAGE,page,deleted=False)
                        self.do_spec_table()
                        paginator,datas = self.do_achieve_records(page)
                        self.do_what = 'get'
            #跳转到添加、修改页面
            elif self.req_method == 'GET':
                try:
                    db_obj  = self.sheet_obj.objects.get(id=int(self.recordid))
                except self.sheet_obj.DoesNotExist:
                    self.do_modify_get_exception()
                else:
                    #db_obj.pk_profit_add= json.loads(db_obj.pk_profit_add)                    
                    datas   = self.do_modify_get_special_field(db_obj)
            if self.sheetid != 'model' and self.do_what in ['add','modify']:
                self.edit_template(datas)
        elif self.do_what == 'delete':
            #删除反馈记录
            if self.req_method == 'POST':
                recordids   = self.request.REQUEST.getlist('recordids')
            elif self.req_method == 'GET':
                recordids   = [self.recordid]
            for recordid in recordids:
                try:
                    db_obj  = self.sheet_obj.objects.get(id=int(recordid))
                except self.sheet_obj.DoesNotExist:
                    pass
                else:
                    self.do_record_del(db_obj)
            #paginator,datas = self.paging(self.sheet_obj,PER_PAGE,page,deleted=False)
            paginator,datas = self.do_achieve_records(page)
            self.do_what = 'get'
        print 'self.tips: ',self.tips
        self.content.update({'datas': datas, 
                             'title': self.pvalues,
                             'data_title': self.sheetname,
                             'tips': self.tips,
                             'recordid': self.recordid,
                             'page': page,
                             'do_what': self.do_what,
                             'paginator': paginator,
                             'pkeys': self.pkeys,
                             'full_screen_swf': self.full_screen_swf,
                             'full_screen_swf_name': self.full_screen_swf_name,
                             'card_type': self.card_type,
                             'view_all': self.view_all,
                             'temp_html': self.temp_html,
                             'order': self.order,
                             })
        
if __name__ == "__main__":
    
    print __file__
#    model   = __import__('operate_backend')
    obj = ParamMain()
    getattr(obj, 'test_getattr')()
    
    